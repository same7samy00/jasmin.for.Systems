<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة وحجز - عيادتي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <div class="main-content-wrapper">
        <header class="page-header">
            <h1>إضافة مريض وحجز موعد</h1>
            <p>سجل بيانات المريض والموعد الأول له.</p>
        </header>

        <form id="patientBookingForm">
            <div class="form-container">
                <h2>بيانات المريض</h2>
                <div id="uniqueness-message" style="color: var(--error-color); margin-bottom: 10px; font-weight: bold;"></div>
                
                <div class="form-group">
                    <label class="label-with-icon"><i class="fas fa-user"></i>الاسم الكامل</label>
                    <input type="text" id="patientName" required>
                </div>
                 <div class="form-group">
                    <label class="label-with-icon"><i class="fas fa-phone"></i>رقم الهاتف</label>
                    <input type="tel" id="patientPhone" required>
                </div>
                
                <div id="dynamic-fields-container"></div>
            </div>

            <div class="form-container">
                <h2>تفاصيل الحجز</h2>
                 <div class="form-group">
                    <label class="label-with-icon"><i class="fas fa-calendar-alt"></i>التاريخ</label>
                    <input type="date" id="appointmentDate" required>
                </div>
                <div class="form-group">
                    <label class="label-with-icon"><i class="fas fa-clock"></i>الوقت</label>
                    <input type="time" id="appointmentTime" required>
                </div>
            </div>

            <button type="submit" class="submit-btn">تسجيل وحجز</button>
        </form>
    </div>

    <nav>
        <a href="index.html"><i class="fas fa-home"></i> <span>الرئيسية</span></a>
        <a href="patient-booking.html" class="active"><i class="fas fa-user-plus"></i> <span>إضافة وحجز</span></a>
        <a href="#"><i class="fas fa-cog"></i> <span>الإعدادات</span></a>
    </nav>

    <script>
        const supabaseUrl = 'YOUR_SUPABASE_URL'; // ❗ استبدل
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // ❗ استبدل
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
        const form = document.getElementById('patientBookingForm');
        const patientNameInput = document.getElementById('patientName');
        const uniquenessMessage = document.getElementById('uniqueness-message');

        async function generateCustomForm() {
            // This function will create the form based on what you define in the 'form_fields' table
            // To test, add fields manually to your 'form_fields' table in Supabase for now
            // Example: field_label: 'فصيلة الدم', field_name: 'blood_type'
            const { data: fields, error } = await supabase.from('form_fields').select('*');
            if (error || !fields) return;
            
            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.innerHTML = `
                    <label class="label-with-icon"><i class="fas fa-clipboard-list"></i> ${field.field_label}</label>
                    <input type="text" id="custom_${field.field_name}" name="${field.field_name}" value="${field.default_value || ''}">
                `;
                dynamicFieldsContainer.appendChild(formGroup);
            });
        }

        let typingTimeout;
        patientNameInput.addEventListener('input', () => {
            clearTimeout(typingTimeout);
            uniquenessMessage.textContent = '';
            typingTimeout = setTimeout(async () => {
                const name = patientNameInput.value.trim();
                if (name.length > 2) {
                    const { data } = await supabase.from('patients').select('id').eq('name', name);
                    if (data && data.length > 0) {
                        uniquenessMessage.textContent = 'هذا الاسم مسجل بالفعل.';
                    }
                }
            }, 500);
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (uniquenessMessage.textContent) {
                alert('لا يمكن إضافة مريض بنفس الاسم.');
                return;
            }
            
            const customData = {};
            dynamicFieldsContainer.querySelectorAll('input').forEach(input => {
                customData[input.name] = input.value;
            });
            
            try {
                const { data: patient, error: pError } = await supabase.from('patients').insert({
                    name: patientNameInput.value,
                    phone_number: document.getElementById('patientPhone').value,
                    custom_data: customData
                }).select('id').single();
                if (pError) throw pError;
                
                const { error: aError } = await supabase.from('appointments').insert({
                    patient_id: patient.id,
                    appointment_date: document.getElementById('appointmentDate').value,
                    time_slot: document.getElementById('appointmentTime').value,
                    status: 'مؤكدة'
                });
                if (aError) throw aError;
                
                alert('تم تسجيل المريض وحجز الموعد بنجاح!');
                form.reset();
            } catch (error) {
                alert(`خطأ: ${error.message}`);
            }
        });
        
        document.addEventListener('DOMContentLoaded', generateCustomForm);
    </script>
</body>
</html>
